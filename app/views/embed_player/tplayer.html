<head>
  <%= stylesheet_link_tag "jPlayer.css" %>
  <%= stylesheet_link_tag "tplayer" %>
  <%= javascript_include_tag "jquery" %>
  <%= javascript_include_tag "jquery.jplayer" %>
  <%= javascript_include_tag "tplayer" %>
  <script type="text/javascript">
    $(document).ready(function(){
      $("#pua-tplayer-<%= @file_id %>").jPlayer({
        ready: function () {
          $(this).jPlayer("setMedia", {
            mp3: "<%= @mp3 %>",
          });
          $("#jp-reverse-button-<%= @file_id %>").on('click', function() {
            $("#pua-tplayer-<%= @file_id %>").jPlayer('playHead', 0);
          });
        },
        loadedmetadata: function() {
          var jplayer = this;
          console.log('loadedmetadata', this);
          jplayer.puaTplayer = new PUATPlayer($('#jp_container-<%= @file_id %>'), jplayer);
          $('#pua-tplayer-<%= @file_id %>-transcript .pua-tplayer-text').click(function() {
            var clicked = this;
            var offset  = $(clicked).data('offset');
            //console.log('clicked on text with id', clicked.id, offset);
            $(jplayer).jPlayer('play', offset);
          });
          $('#pua-tplayer-<%= @file_id %>-transcript .pua-tplayer-text').hover(
            function() { $(this).addClass('hover'); },
            function() { $(this).removeClass('hover'); }
          );
          console.log('metadata listeners set');
        },
        progress: function(ev) {
          var player = this;
          //console.log('player progress', player);
        },
        timeupdate: function(ev) {
          var curOffset = Math.floor( ev.jPlayer.status.currentTime );
          // if the current offset matches a text id, select the text
          var target = $('#pua-tplayer-text-<%= @file_id %>-'+curOffset);
          if (target && target.length && !target.hasClass('selected')) {
            // de-select any currently selected first
            var curSelected = $("#pua-tplayer-<%= @file_id %>-transcript .pua-tplayer-text.selected");
            curSelected.removeClass('selected');
            // select new target
            target.addClass('selected');
            // scroll
            var scrollMath = {};
            scrollMath.rowsBefore = 2;
            scrollMath.lineNum    = parseInt( target.data('idx') );
            var tgtWrap = $("#pua-tplayer-<%= @file_id %>-transcript.scrolling tbody");
            // we want to scroll the sum of the heights of all rows before the current one, less rowsBefore height.
            if (scrollMath.lineNum < scrollMath.rowsBefore) {
              scrollMath.scrollTo = 0;  // already near the top
            }
            else {
              // get the sum of heights for the range of rows.
              // we can't assume that all rows are the same height because lines wrap.
              scrollMath.scrollTo = 0;
              scrollMath.stopper = scrollMath.lineNum - scrollMath.rowsBefore - 1;  // minus one because idx below is zero-based
              if (scrollMath.stopper < 0) scrollMath.stopper = 0;
              var allRows = $("#pua-tplayer-<%= @file_id %>-transcript .pua-tplayer-text");
              allRows.each(function(idx,el) {
                //console.log(idx + ' -> ' + $(el)[0].scrollHeight);
                scrollMath.scrollTo += $(el)[0].scrollHeight;
                if (idx == scrollMath.stopper) return false; // abort loop
              });
            }
            console.log('scrollMath: ', scrollMath);
            tgtWrap.animate({ scrollTop: scrollMath.scrollTo }, 200);
          }
          //console.log('player timeupdate', curOffset);
        },
        ended: function() {
          var player = this;
          console.log('player ended', player);
        },
        cssSelectorAncestor: '#jp_container-<%= @file_id %>',
        smoothPlayBar: true,
        keyEnabled: true,
        remainingDuration: true,
        toggleDuration: true,
        swfPath: "<%= asset_path 'Jplayer.swf' %>",
        solution: "html, flash",
        supplied: "mp3",
      });
      $("#jplayer_inspector-<%= @file_id %>").jPlayerInspector({jPlayer:$("#pua-tplayer-<%= @file_id %>")});
    });
  </script>
</head>
<body>
 <table class="pua-tplayer">
  <tr class="img-player">
   <td class="img">
    <a href="/collections/<%= @audio_file.item.collection_id %>/items/<%= @audio_file.item_id %>/" target="_blank">
      <img src="<%= @audio_file.item.image_url || '/assets/minimark.png' %>" />
    </a>
   </td>
   <td class="tplayer"> 
    <div id="pua-tplayer-<%= @file_id %>" class="jp-jplayer pua-tplayer"></div>
    <div id="jp_container-<%= @file_id %>" class="jp-audio player">
      <div class="jp-type-single">
        <div class="jp-gui jp-interface">
          <div class="jp-title">
            <h2><%= @title %></h2>
          </div>
          <table class="tplayer-bar">
           <tr>
           <td class="jp-controls">
            <button id="jp-reverse-button-<%= @file_id %>" class="jp-rewind player-button">
                <i class="icon-fast-backward"></i>
            <button id="jp-play-button-<%= @file_id %>" class="jp-play player-button">
                <i class="icon-play"></i>
            <button id="jp-pause-button-<%= @file_id %>" class="jp-pause player-button">
                <i class="icon-pause"></i>
           </td>
           <td class="jp-progress">
            <div class="jp-seek-bar">
              <div class="jp-play-bar"></div>
            </div>
           </td>
           <td class="tplayer-stats">
  
            <div class="jp-time-holder">
              <div class="jp-current-time" role="timer" aria-label="time"></div> / 
              <div class="jp-duration" role="timer" aria-label="duration"></div>
            </div>
  
            <div class="pua-links">
              <a class="jp-popuplink pua-up-link" href="/collections/<%= @audio_file.item.collection_id %>/items/<%= @audio_file.item_id %>/" target="_blank"><span title="up"></span></a>
            </div>
  
           <!-- scrubber used for drawing waveform, not displayed -->
            <div class="scrubber"><canvas></canvas></div>
           </td>
  
          </tr>
          </table>
        </div>
        
        <div class="jp-no-solution">
          <span>Update Required</span>
          To play the media you will need to either update your browser to a recent version or update your <a href="http://get.adobe.com/flashplayer/" target="_blank">Flash plugin</a>.
        </div>
      </div>
    </div>
   </td>
  </tr>
 </table>
 <table id="pua-tplayer-<%= @file_id %>-transcript" class="pua-tplayer scrolling">
  <tbody>
  <% tparts = @transcript.has_speaker_ids ? @transcript.chunked_by_speaker : @transcript.chunked_by_time(@chunk_size.to_i) %>
  <% line_num = 0; tparts.each do |tpart| %>
  <tr class="timings-transcript">
   <td class="timings">
     <%= tpart[:speaker] %>
     <%= tpart[:ts] %>
   </td>
   <td class="transcript">
     <% tpart[:text].each_with_index do |ttext,idx| %>
     <div class="pua-tplayer-text" id="pua-tplayer-text-<%= @file_id %>-<%= tpart[:offsets][idx].to_i %>" data-idx="<%= line_num += 1 %>" data-offset="<%= tpart[:offsets][idx].to_i %>"><%= ttext %></div>
     <% end %>
   </td>
  </tr>
  <% end %>
  </tbody>
 </table>
 </div>
</body>
